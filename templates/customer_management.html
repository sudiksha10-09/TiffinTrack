<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customers ‚Äì TiffinTrack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/professional.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body class="app">

<!-- NAVBAR -->
<nav class="navbar">
  <div class="nav-container">
    <div class="logo">üç± TiffinTrack</div>

    <div>
      <a href="{{ url_for('admin_dashboard') }}" class="btn-outline">Dashboard</a>
      <button onclick="handleLogout()" class="btn-secondary">Logout</button>
    </div>
  </div>
</nav>

<!-- PAGE -->
<div class="page">

  <!-- HEADER -->
  <div class="page-header">
    <div class="page-title">
      <h1>Customers</h1>
      <p>Manage all customer subscriptions and payments.</p>
    </div>

    <div class="toolbar">
      <input class="search-input" placeholder="Search customers..." onkeyup="filterCustomers()">
      <button class="btn-primary" onclick="showAddCustomerModal()">+ Add Customer</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-grid">

    <div class="stat-card">
      <div class="stat-icon" style="background:#2563eb;">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-info">
        <h3>Total</h3>
        <p>{{ customers|length }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background:#16a34a;">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-info">
        <h3>Active</h3>
        <p>{{ customers | selectattr('status', 'equalto', 'Active') | list | length }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background:#ca8a04;">
        <i class="fas fa-pause-circle"></i>
      </div>
      <div class="stat-info">
        <h3>Paused</h3>
        <p>{{ customers | selectattr('status', 'equalto', 'Paused') | list | length }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background:#dc2626;">
        <i class="fas fa-credit-card"></i>
      </div>
      <div class="stat-info">
        <h3>Pending</h3>
        <p>{{ customers | selectattr('payment', 'equalto', 'Pending') | list | length }}</p>
      </div>
    </div>

  </div>

  <!-- TABLE -->
  <div class="table-card">

    <div class="table-header">
      Customer List
    </div>

    <table class="dashboard-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Contact</th>
          <th>Area</th>
          <th>Plan</th>
          <th>Status</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody id="customer-table-body">
        {% for customer in customers %}
        <tr>
          <td><strong>{{ customer.name }}</strong></td>
          <td>
            {{ customer.phone }}<br>
            <small style="color:#6b7280;">{{ customer.email }}</small>
          </td>
          <td>{{ customer.area }}</td>
          <td>{{ customer.plan }}</td>
          <td>
            {% if customer.status == 'Active' %}
              <span class="badge-pill badge-active">{{ customer.status }}</span>
            {% else %}
              <span class="badge-pill badge-paused">{{ customer.status }}</span>
            {% endif %}
          </td>
          <td>
            {% if customer.payment == 'Paid' %}
              <span class="badge-pill badge-paid">{{ customer.payment }}</span>
            {% else %}
              <span class="badge-pill badge-pending">{{ customer.payment }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>

</div>

<!-- ADD CUSTOMER MODAL -->
<div id="addCustomerModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Customer</h3>
      <button onclick="hideAddCustomerModal()" class="modal-close">&times;</button>
    </div>
    
    <form id="addCustomerForm">
      <div class="form-grid">
        <div>
          <label>Full Name</label>
          <input type="text" name="fullname" class="input" required>
        </div>
        
        <div>
          <label>Email</label>
          <input type="email" name="email" class="input" required>
        </div>
        
        <div>
          <label>Phone</label>
          <input type="tel" name="phone" class="input" required>
        </div>
        
        <div>
          <label>Delivery Area</label>
          <select name="delivery_area" class="input" required>
            <option value="">Select Area</option>
            <option value="Sector 9">Sector 9</option>
            <option value="Sector 10">Sector 10</option>
            <option value="Sector 11">Sector 11</option>
            <option value="Vashi">Vashi</option>
            <option value="Nerul">Nerul</option>
          </select>
        </div>
        
        <div>
          <label>Address Line 1</label>
          <input type="text" name="addr1" class="input" required>
        </div>
        
        <div>
          <label>Address Line 2</label>
          <input type="text" name="addr2" class="input">
        </div>
        
        <div>
          <label>City</label>
          <input type="text" name="city" class="input" required>
        </div>
        
        <div>
          <label>State</label>
          <input type="text" name="state" class="input" required>
        </div>
        
        <div>
          <label>Pincode</label>
          <input type="text" name="pincode" class="input" required>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" onclick="hideAddCustomerModal()" class="btn-outline">Cancel</button>
        <button type="submit" class="btn-primary">Add Customer</button>
      </div>
    </form>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #6b7280;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  padding: 20px;
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding: 20px;
  border-top: 1px solid #e5e7eb;
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
function filterCustomers() {
  const searchTerm = document.querySelector('.search-input').value.toLowerCase();
  const rows = document.querySelectorAll('#customer-table-body tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
}

function showAddCustomerModal() {
  document.getElementById('addCustomerModal').style.display = 'flex';
}

function hideAddCustomerModal() {
  document.getElementById('addCustomerModal').style.display = 'none';
  document.getElementById('addCustomerForm').reset();
}

document.getElementById('addCustomerForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());
  
  try {
    const response = await fetch('/customers/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Customer added successfully!');
      location.reload();
    } else {
      alert('Error: ' + result.message);
    }
  } catch (error) {
    alert('Error adding customer');
  }
});

function handleLogout() {
  window.location.href = "{{ url_for('logout') }}";
}
</script>

</body>
</html>
